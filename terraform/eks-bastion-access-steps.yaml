# # ุฎุทูุงุช ุฑุจุท ุงูู Bastion ุจููุงุณุชุฑ EKS ุงูุจุฑุงููุช ุจุนุฏ ุฃู terraform apply
# # (ุชุชูููุฐ ูููุง ูู ุฌููู ุงูุจุงุณุชููู)

# cluster:
#   name: flower-shop-cluster
#   region: us-east-1
#   bastion_role_name: bastion-role

# steps:

#   - step: 1
#     title: "ุฏุฎูู ูู IAM Admin ูุฑุฉ ูุงุญุฏุฉ (bootstrap)"
#     description: >
#       ุงูุฎุทูุฉ ุฏู ุจุณ ุนูุดุงู ููุฏุฑ ูุนุฏูู aws-auth ููุถูู bastion-role ุฌููู ุงูููุงุณุชุฑ.
#       ุจุชุชุนูู ุจุนุฏ ูุง ุงูููุงุณุชุฑ ูููู ุจุงูู Terraform.
#     commands:
#    ๐ช๐ช   - "# ุนูู ุงูุจุงุณุชููู:"
#       - aws configure


#       - "# ุญุท AWS Access Key / Secret ุจุชูุน ุงูููุฒุฑ admin (ูุซูุงู terraform)"
#       -%%$$ aws sts get-caller-identity &&%%$$
#       - "# ุชุฃูุฏ ุฅู Arn ููู user/terraform ูุด assumed-role/bastion-role"

#   - step: 2
#     title: "ุชุญุฏูุซ kubeconfig ุจููููุฉ ุงูู admin"
#     commands:
#       - aws eks update-kubeconfig --name flower-shop-cluster --region us-east-1
# incase kubeconfig not found:

#description of the issue:
# The connection to the server localhost:8080 was refused
# ุฏู ุทุจูุนู ุฌุฏูุง ูู ุงูุญุงูุฉ ุฏูุ ูุนูุงู ุจุณ ุฅู kubectl ูููุงุด kubeconfig ุตุญุ ูุงูุชุฑุถ ุฅูู ููููู Kubernetes ุนูู localhost:8080ุ ูุฏู ูุด ููุฌูุฏ.

# ุจุนุฏ ูุง ูุนุฏูู ุงูุตูุงุญูุงุช ููุดุบูู aws eks update-kubeconfig ุงูููุฑูุถ ูุฎุชูู ุฎุงูุต. ๐ข
# #       please run: the below commands      ############
# # ##sudo mkdir -p /home/ubuntu/.kube
# # sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
# # aws eks update-kubeconfig --name flower-shop-cluster --region us-east-1
# # #       - kubectl get pods -A
# kubectl get nodes
#       - "# ูู ูููุด ููุฏุฒ (Fargate) ุนุงุฏู ูููู ูุทูุน No resources found"

#   - step: 3
#     title: "ุชุนุฏูู aws-auth ูุฅุถุงูุฉ bastion-role ูู system:masters"
#     description: >
#       ุงููุฏู ุฅู ุฃู ุชููู ุฌุงู ูู IAM Role bastion-role ูุจูู ููู ุตูุงุญูุงุช admin ุฌููู ุงูููุงุณุชุฑ.
#     commands:
#       - kubectl edit configmap aws-auth -n kube-system
#       - |
#         # ุฌููู ุงูููู ุงููู ูููุชุญุ ุฏูุฑ ุนูู:
#         #   mapRoles: |
#         # ูุชุญุช ุขุฎุฑ role ููุฌูุฏุ ุถูู ุงูุจููู ุฏู (ุจููุณ ุงูู indent):

#         - rolearn: arn:aws:iam::163511166008:role/bastion-role
#           username: bastion-admin
#           groups:
#             - system:masters

#       - "# ุงุญูุธ ูุงุฎุฑุฌ (:wq ูู vi/vim)"
##################################################
# ุฅุฐุง ููุช ุชุณุชุฎุฏู Vim (ูุญุฑุฑ ููู ูุดุงุฆุน):
# ุชุฃูุฏ ุฃูู ูู ูุถุน ุงูุฃูุงูุฑ (Command Mode) ุจุงูุถุบุท ุนูู ููุชุงุญ Esc.

# ุงุถุบุท ุนูู ููุชุงุญ g ูุฑุชูู (ุฃู gg) ููุงูุชูุงู ุฅูู ุงูุณุทุฑ ุงูุฃูู.

# ุงูุชุจ ุงูุฃูุฑ ุงูุชุงูู: dG

# ุงูุฃูุฑ dG ูููู ุจุญุฐู ูู ุดูุก ูู ุงูุณุทุฑ ุงูุญุงูู ุฅูู ููุงูุฉ ุงูููู.
ex
###################################################3
#   - step: 4
#     title: "ูุณุญ ูุฑูุฏูุดุงูุฒ ุงูู admin ูู ุงูุจุงุณุชููู"
#     description: >
#       ูู ุฏูููุชู ูุทุงูุน ุนุงูุฒูู ูุดุชุบู ุจููููุฉ EC2 instance profile (bastion-role) ุจุณ.
#     commands:
#       - rm -f ~/.aws/credentials
#       - rm -f ~/.aws/config
#       - aws sts get-caller-identity
#       - "# ุงูููุฑูุถ Arn ูุจูู: arn:aws:sts::...:assumed-role/bastion-role/..."

#   - step: 5
#     title: "ุชุญุฏูุซ kubeconfig ุจููููุฉ bastion-role ูุงูุชุฃูุฏ ุฅู ุงูู Access ุดุบุงู"
#     commands:
#       - aws eks update-kubeconfig --name flower-shop-cluster --region us-east-1
#       - kubectl get nodes
#       - kubectl get pods -A
#       - "# ูู ุงูุฃูุงูุฑ ุฏู ุงุดุชุบูุช ูู ุบูุฑ Error, ูุจูู ุงูุจุงุณุชููู ุจูู Admin ุนูู ุงูููุงุณุชุฑ."

# notes:
#   - >
#     ูู ุนููุช terraform destroy && terraform apply:
#       1) ุงุณุชูู ุงูููุงุณุชุฑ ูุฎูุต ุฅูุดุงุก.
#       2) ssh ุนูู ุงูุจุงุณุชููู.
#       3) ูุฑุฑ ุงูุฎุทูุงุช ูู Step 1 ูุญุฏ Step 5 ุฒู ูุง ูู ูู ุงูููู ุฏู.
#   - >
#     ุงูุจููู ุงููุญูุฏ ุงูุซุงุจุช ูู bastion-role, ูุฃู ARN ุจุชุงุนู ุซุงุจุช ุทูู ูุง ุงูุช
#     ูุง ุบูุฑุชุด ุงุณู ุงูู role ูู Terraform.
#     ุงูู Fargate roles ูููู Arnold ุจุชุงุนูุง ูุชุบูุฑ ูุน ุฅุนุงุฏุฉ ุงูุฅูุดุงุกุ ูุณูุจูุง ููู Terraform/module
#     ูุชุนุงูู ูุนุงูุงุ ูุฅูุช ุจุณ ุฑููุฒ ุนูู ุฅุถุงูุฉ bastion-role.



# ๐ฏ ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู ุงูุนููู (ูุฎุชุตุฑุฉ)

# ูู ูุง ุชุนูู:

# terraform destroy
# terraform apply


# ูุชูุงูู ุงูููุงุณุชุฑ ุงุดุชุบูุ ุชุนูู ูู ุนูู ุงูุจุงุณุชููู:

# Step 1 + 2 ูู ุงูููู

# aws configure ุจููููุฉ admin (ููุฒุฑ terraform)

# aws eks update-kubeconfig ...

# kubectl get nodes

# Step 3

# kubectl edit configmap aws-auth -n kube-system

# ุชุญุช mapRoles: | ุฒููุฏ:

# - rolearn: arn:aws:iam::163511166008:role/bastion-role
#   username: bastion-admin
#   groups:
#     - system:masters


# Step 4 + 5

# ุงูุณุญ ~/.aws/credentials ู ~/.aws/config

# ุชุฃูุฏ ุฅู aws sts get-caller-identity ุฑุฌุน assumed-role/bastion-role

# aws eks update-kubeconfig ...

# kubectl get pods -A

# ุฎูุงุตุ ูุฏู ุงูููุงุณุชุฑ privateุ
# ูุงูู access ููู ูู ุงูุจุงุณุชููู ููุทุ
# ูุงูู bastion-role admin ุฌููู EKS.